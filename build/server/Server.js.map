{"version":3,"sources":["Server.js"],"names":[],"mappings":"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","file":"Server.js","sourcesContent":["import express from 'express';\nimport zlib from 'zlib';\nimport fs from 'fs';\nimport os from 'os';\nimport compression from 'compression';\nimport {Server as WebSocketServer} from 'ws';\nimport http from 'http';\nimport url from 'url';\nimport net from 'net';\nimport Throttle from 'throttle';\nimport random from 'lodash/number/random';\nimport indexTemplate from './templates/index';\nimport postsTemplate from './templates/posts';\nimport postTemplate from './templates/post';\nimport remoteExecutorTemplate from './templates/remote-executor';\nimport idbTestTemplate from './templates/idb-test';\nimport {generateReady, generateMessage} from './generateMessage';\n\nconst maxMessages = 30;\n\nconst compressor = compression({\n  flush: zlib.Z_PARTIAL_FLUSH\n});\n\nconst appServerPath = os.platform() == 'win32' ?\n  '\\\\\\\\.\\\\pipe\\\\offlinefirst' + Date.now() + '.sock' :\n  'offlinefirst.sock';\n\nconst connectionProperties = {\n  perfect: {bps: 100000000, delay: 0},\n  slow: {bps: 4000, delay: 3000},\n  'lie-fi': {bps: 1, delay: 10000}\n};\n\nconst imgSizeToFlickrSuffix = {\n  '1024px': 'b',\n  '800px': 'c',\n  '640px': 'z',\n  '320px': 'n'\n};\n\nfunction findIndex(arr, func) {\n  for (let i = 0; i < arr.length; i++) {\n    if (func(arr[i], i, arr)) return i;\n  }\n  return -1;\n}\n\nexport default class Server {\n  constructor(port) {\n    this._app = express();\n    this._messages = [];\n    this._sockets = [];\n    this._serverUp = false;\n    this._appServerUp = false;\n    this._port = port;\n    this._connectionType = '';\n    this._connections = [];\n\n    this._appServer = http.createServer(this._app);\n    this._exposedServer = net.createServer();\n\n    this._wss = new WebSocketServer({\n      server: this._appServer,\n      path: '/updates'\n    });\n    \n    const staticOptions = {\n      maxAge: 0\n    };\n\n    this._exposedServer.on('connection', socket => this._onServerConnection(socket));\n    this._wss.on('connection', ws => this._onWsConnection(ws));\n\n    this._app.use(compressor);\n    this._app.use('/js', express.static('../public/js', staticOptions));\n    this._app.use('/css', express.static('../public/css', staticOptions));\n    this._app.use('/imgs', express.static('../public/imgs', staticOptions));\n    this._app.use('/avatars', express.static('../public/avatars', staticOptions));\n    this._app.use('/sw.js', express.static('../public/sw.js', staticOptions));\n    this._app.use('/sw.js.map', express.static('../public/sw.js.map', staticOptions));\n    this._app.use('/manifest.json', express.static('../public/manifest.json', staticOptions));\n\n    this._app.get('/', (req, res) => {\n      res.send(indexTemplate({\n        scripts: '<script src=\"/js/main.js\" defer></script>',\n        content: postsTemplate({\n          content: this._messages.map(item => postTemplate(item)).join('')\n        })\n      }));\n    });\n\n    this._app.get('/skeleton', (req, res) => {\n      res.send(indexTemplate({\n        scripts: '<script src=\"/js/main.js\" defer></script>',\n        content: postsTemplate()\n      }));\n    });\n\n    this._app.get('/photos/:farm-:server-:id-:secret-:type.jpg', (req, res) => {\n      const flickrUrl = `http://farm${req.params.farm}.staticflickr.com/${req.params.server}/${req.params.id}_${req.params.secret}_${imgSizeToFlickrSuffix[req.params.type]}.jpg`;\n      const flickrRequest = http.request(flickrUrl, flickrRes => {\n        flickrRes.pipe(res);\n      });\n\n      flickrRequest.on('error', err => {\n        // TODO: use a real flickr image as a fallback\n        res.sendFile('imgs/icon.png', {\n          root: __dirname + '/../public/'\n        });\n      });\n\n      flickrRequest.end();\n    });\n\n    this._app.get('/ping', (req, res) => {\n      res.set('Access-Control-Allow-Origin', '*');\n      res.status(200).send({ok: true});\n    });\n\n    this._app.get('/remote', (req, res) => {\n      res.send(remoteExecutorTemplate());\n    });\n\n    this._app.get('/idb-test/', (req, res) => {\n      res.send(idbTestTemplate());\n    });\n\n    generateReady.then(_ => {\n      // generate initial messages\n      let time = new Date();\n\n      for (let i = 0; i < maxMessages; i++) {\n        const msg = generateMessage();\n        const timeDiff = random(5000, 15000);\n        time = new Date(time - timeDiff);\n        msg.time = time.toISOString();\n        this._messages.push(msg);\n      }\n\n      this._generateDelayedMessages();\n    });\n  }\n\n  _generateDelayedMessages() {\n    setTimeout(_ => {\n      this._addMessage();\n      this._generateDelayedMessages();\n    }, random(5000, 15000));\n  }\n\n  _broadcast(obj) {\n    const msg = JSON.stringify(obj);\n    this._sockets.forEach(socket => socket.send(msg));\n  }\n\n  _onServerConnection(socket) {\n    let closed = false;\n    this._connections.push(socket);\n\n    socket.on('close', _ => {\n      closed = true;\n      this._connections.splice(this._connections.indexOf(socket), 1);\n    });\n\n    socket.on('error', err => console.log(err));\n\n    const connection = connectionProperties[this._connectionType];\n    const makeConnection = _ => {\n      if (closed) return;\n      const appSocket = net.connect(appServerPath);\n      appSocket.on('error', err => console.log(err));\n      socket.pipe(new Throttle(connection.bps)).pipe(appSocket);\n      appSocket.pipe(new Throttle(connection.bps)).pipe(socket);\n    };\n\n    if (connection.delay) {\n      setTimeout(makeConnection, connection.delay);\n      return;\n    }\n    makeConnection();\n  }\n\n  _onWsConnection(socket) {\n    const requestUrl = url.parse(socket.upgradeReq.url, true);\n\n    if ('no-socket' in requestUrl.query) return; \n\n    this._sockets.push(socket);\n\n    socket.on('close', _ => {\n      this._sockets.splice(this._sockets.indexOf(socket), 1);\n    });\n\n    let sendNow = [];\n\n    if (requestUrl.query.since) {\n      const sinceDate = new Date(Number(requestUrl.query.since));\n      let missedMessages = findIndex(this._messages, msg => new Date(msg.time) <= sinceDate);\n      if (missedMessages == -1) missedMessages = this._messages.length;\n      sendNow = this._messages.slice(0, missedMessages);\n    }\n    else {\n      sendNow = this._messages.slice();\n    }\n\n    if (sendNow.length) {\n      socket.send(JSON.stringify(sendNow));\n    }\n  }\n\n  _addMessage() {\n    const message = generateMessage();\n    this._messages.unshift(message);\n    this._messages.pop();\n    this._broadcast([message]);\n  }\n\n  _listen() {\n    this._serverUp = true;\n    this._exposedServer.listen(this._port, _ => {\n      console.log(\"Server listening at localhost:\" + this._port);\n    });\n\n    if (!this._appServerUp) {\n      if (fs.existsSync(appServerPath)) fs.unlinkSync(appServerPath);\n      this._appServer.listen(appServerPath);\n      this._appServerUp = true;\n    }\n  }\n\n  _destroyConnections() {\n    this._connections.forEach(c => c.destroy());\n  }\n\n  setConnectionType(type) {\n    if (type === this._connectionType) return;\n    this._connectionType = type;\n    this._destroyConnections();\n\n    if (type === 'offline') {\n      if (!this._serverUp) return;\n      this._exposedServer.close();\n      this._serverUp = false;\n      return;\n    }\n\n    if (!this._serverUp) {\n      this._listen();\n    }\n  }\n}"]}